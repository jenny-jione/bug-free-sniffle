<!-- <!DOCTYPE html> -->
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>서울 구역별 지도</title>
  <link rel="stylesheet" href="./stylesheets/master.css"/>
  <style>
    .area {
      position: absolute;
      background: #fff;
      border: 1px solid #888;
      border-radius: 3px;
      font-size: 12px;
      top: -5px;
      left: 15px;
      padding: 2px;
    }
  </style>
</head>

<body>
  <div id="gu"></div>
  <div id="dong"></div>
  <div id="map" style="width:80%;height:600px;"></div>

  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=fb43fa40801b0b7e7c472c9a56ef7eca"></script>
  <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>

  <script>
    var mapContainer = document.getElementById('map'), // 지도를 표시할 div
      mapOption = {
        center: new kakao.maps.LatLng(37.5642135, 127.0016985), // 지도의 중심좌표
        level: 9 // 지도의 확대 레벨
      };

    var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다
    console.log("map 생성 완료");
  </script>

  <script>
    //행정구역 구분
    var cnt = 0;
    var mcnt = 0;
    $(document).ready(function() {
      $.getJSON("seoul_10percent.json", function(geojson) {
        console.log("getJSON ok");

        var data = geojson.features;
        var coordinates = []; //좌표 저장할 배열
        var name = ''; //행정 구 이름
        var districts = []; // 구 저장하는 배열

        $.each(data, function(index, val) {

          coordinates = val.geometry.coordinates;
          name = val.properties.SIG_KOR_NM;
          districts.push(name);
          displayArea(coordinates, name);
        });
      });



      var polygons = []; //function 안 쪽에 지역변수로 넣으니깐 폴리곤 하나 생성할 때마다 배열이 비어서 클릭했을 때 전체를 못 없애줌.  그래서 전역변수로 만듦.
      var overlays = [];

      //행정구역 폴리곤
      function displayArea(coordinates, name) {
        //폴리곤 그려줄 path 배열 (각 지역구 폴리곤)
        var path = [];
        //중심좌표 구하기 위한 지역구 좌표들 배열
        var points = [];
        // 각 지역구 중심좌표 저장하는 배열
        var district_centers = [];

        //console.log(coordinates)를 확인해보면 보면 [0]번째에 배열이 주로 저장이 됨.  그래서 [0]번째 배열에서 꺼내줌.
        $.each(coordinates[0], function(index, coordinate) { // 25번 반복
          var point = new Object();
          point.x = coordinate[1];
          point.y = coordinate[0];
          points.push(point);
          path.push(new kakao.maps.LatLng(coordinate[1], coordinate[0]));

          //new kakao.maps.LatLng가 없으면 인식을 못해서 path 배열에 추가
        });

        district_centers.push(centroid(points));
        $.each(district_centers, function(index, item) {
          // 커스텀 오버레이에 표시할 내용입니다
          // HTML 문자열 또는 Dom Element 입니다
          // var content = '<p style="font-size:12px;"><b>' + name + '</p>';

          // 커스텀 오버레이가 표시될 위치입니다
          // var position = item;

          // 커스텀 오버레이를 생성합니다
          // var customOverlay = new kakao.maps.CustomOverlay({
          //   position: position,
          //   content: content
          // });
          customOverlay = new kakao.maps.CustomOverlay({});

          // 커스텀 오버레이를 지도에 표시합니다
          // customOverlay.setMap(map);
          overlays.push(customOverlay);

        });

        // 다각형을 생성합니다
        var polygon = new kakao.maps.Polygon({
          map: map, // 다각형을 표시할 지도 객체
          path: path,
          strokeWeight: 3,
          strokeColor: '#8a4e91', // blue: 004c80; green: 00785c
          strokeOpacity: 0.8,
          fillColor: '#fff',
          fillOpacity: 0.7
        });

        //폴리곤 제거하기 위한 배열
        polygons.push(polygon);


        // 다각형에 mouseover 이벤트를 등록하고 이벤트가 발생하면 폴리곤의 채움색을 변경합니다
        kakao.maps.event.addListener(polygon, 'mouseover', function(mouseEvent) {
          polygon.setOptions({
            fillColor: '#e1b8e6' // blue: 09f
          });
          console.log(++mcnt);
          document.getElementById("gu").innerHTML = name;
          customOverlay.setContent('<div class="area">' + name + '</div>');

          customOverlay.setPosition(mouseEvent.latLng);
          customOverlay.setMap(map);
          // console.log(name);
        });



        // 다각형에 mouseout 이벤트를 등록하고 이벤트가 발생하면 폴리곤의 채움색을 원래색으로 변경합니다
        // 커스텀 오버레이를 지도에서 제거합니다
        kakao.maps.event.addListener(polygon, 'mouseout', function() {
          polygon.setOptions({
            fillColor: '#fff'
          });
        });


        // 다각형에 click 이벤트를 등록하고 이벤트가 발생하면 해당 지역 확대
        kakao.maps.event.addListener(polygon, 'click', function() {
          // 현재 지도 레벨에서 2레벨 확대한 레벨
          var level = map.getLevel() - 2;

          // 지도를 클릭된 폴리곤의 중앙 위치를 기준으로 확대합니다
          map.setLevel(level, {
            anchor: centroid(points),
            animate: {
              duration: 350 //확대 애니메이션 시간
            }
          });
          deletePolygon(polygons); //폴리곤 제거
          deleteDistrict(overlays);

          redrawPolygon(path, name); // 클릭한 다각형만 다시 그리기
        });



      } // displayArea 함수 끝



      //centroid 알고리즘 (폴리곤 중심좌표 구하기 위함)
      function centroid(points) {
        var i, j, len, p1, p2, f, area, x, y;

        area = x = y = 0;

        for (i = 0, len = points.length, j = len - 1; i < len; j = i++) {
          p1 = points[i];
          p2 = points[j];

          f = p1.y * p2.x - p2.y * p1.x;
          x += (p1.x + p2.x) * f;
          y += (p1.y + p2.y) * f;
          area += f * 3;
        }
        return new kakao.maps.LatLng(x / area, y / area);
      }


      // 지도 위 표시되고 있는 폴리곤 제거
      function deletePolygon(polygons) {
        for (var i = 0; i < polygons.length; i++) {
          polygons[i].setMap(null);
        }
        polygons = [];
      }


      // 지도 위에 있던 구 이름 제거
      function deleteDistrict(overlays) {
        for (var i = 0; i < overlays.length; i++) {
          overlays[i].setMap(null);
        }
        overlays = [];
      }




      // 클릭한 폴리곤 다시 그리는 함수
      function redrawPolygon(path, gu) {
        console.log("redraw");
        var polygon = new kakao.maps.Polygon({
          map: map, // 다각형을 표시할 지도 객체
          path: path,
          strokeWeight: 3,
          strokeColor: '#8a4e91', // blue: 004c80; green: 00785c
          strokeOpacity: 0.8,
          fillColor: '#fff',
          fillOpacity: 0.7
        });

        console.log("Redraw:" + gu);
        // 여기에 동 다각형 그리는 코드!!
        // TODO: 특정 구를 클릭하면 그 구 안에 있는 동들만 표시되도록 하기.

        $.getJSON("seoul_dong_10percent.json", function(geojson) {
          console.log("getJSON (dong) ok");

          var data = geojson.features;
          var d_coordinates = []; // 동 좌표 저장할 배열
          var d_name = ''; //행정동 이름
          var dongs = []; // 동 저장하는 배열
          var count = 0;

          // console.log(data[0].properties.EMD_KOR_NM);
          // console.log(data[0].geometry.coordinates);

          $.each(data, function(index, val) {
            d_coordinates = val.geometry.coordinates;
            // console.log(val.geometry.coordinates[0]);
            d_name = val.properties.EMD_KOR_NM;
            console.log(count++);
            console.log(d_name);
            dongs.push(d_name);
            displayDong(d_coordinates, d_name);
          });
        });




      }



      function displayDong(coordinates, name) {
        //폴리곤 그려줄 path 배열 (각 동 폴리곤)
        var path = [];
        //중심좌표 구하기 위한 동 좌표들 배열
        var points = [];
        // 각 동 중심좌표 저장하는 배열
        var dong_centers = [];

        //console.log(coordinates)를 확인해보면 보면 [0]번째에 배열이 주로 저장이 됨.  그래서 [0]번째 배열에서 꺼내줌.
        $.each(coordinates[0], function(index, coordinate) { // 467번 반복
          var point = new Object();
          point.x = coordinate[1];
          point.y = coordinate[0];
          points.push(point);
          path.push(new kakao.maps.LatLng(coordinate[1], coordinate[0]));

          //new kakao.maps.LatLng가 없으면 인식을 못해서 path 배열에 추가
        });

        dong_centers.push(centroid(points));
        $.each(dong_centers, function(index, item) {
          // 커스텀 오버레이에 표시할 내용입니다
          // HTML 문자열 또는 Dom Element 입니다
          var content = '<p style="font-size:12px;"><b>' + name + '</p>';

          // 커스텀 오버레이가 표시될 위치입니다
          var position = item;

          // 커스텀 오버레이를 생성합니다
          var customOverlay = new kakao.maps.CustomOverlay({
            position: position,
            content: content
          });

          // 커스텀 오버레이를 지도에 표시합니다
          // customOverlay.setMap(map);
          overlays.push(customOverlay);

        });

        // 다각형을 생성합니다
        var polygon = new kakao.maps.Polygon({
          map: map, // 다각형을 표시할 지도 객체
          path: path,
          strokeWeight: 1,
          strokeColor: '#8a4e91', // blue: 004c80; green: 00785c, purple: 8a4e91;
          strokeOpacity: 0.8,
          fillColor: '#fff',
          fillOpacity: 0.4
        });

        //폴리곤 제거하기 위한 배열
        polygons.push(polygon);


        // 다각형에 mouseover 이벤트를 등록하고 이벤트가 발생하면 폴리곤의 채움색을 변경합니다
        kakao.maps.event.addListener(polygon, 'mouseover', function(mouseEvent) {
          polygon.setOptions({
            fillColor: '#e1b8e6', // blue: 09f, e1b8e6
          });
          console.log(++mcnt);
          document.getElementById("dong").innerHTML = name;
        });


        // 다각형에 mouseout 이벤트를 등록하고 이벤트가 발생하면 폴리곤의 채움색을 원래색으로 변경합니다
        // 커스텀 오버레이를 지도에서 제거합니다
        kakao.maps.event.addListener(polygon, 'mouseout', function() {
          polygon.setOptions({
            fillColor: '#fff'
          });
        });


        // // 다각형에 click 이벤트를 등록하고 이벤트가 발생하면 해당 지역 확대
        // kakao.maps.event.addListener(polygon, 'click', function() {
        //   // 현재 지도 레벨에서 2레벨 확대한 레벨
        //   var level = map.getLevel() - 2;
        //
        //   // 지도를 클릭된 폴리곤의 중앙 위치를 기준으로 확대합니다
        //   map.setLevel(level, {
        //     anchor: centroid(points),
        //     animate: {
        //       duration: 350 //확대 애니메이션 시간
        //     }
        //   });
        //   deletePolygon(polygons); //폴리곤 제거
        //   deleteDistrict(overlays);
        //
        //   redrawPolygon(path, name); // 클릭한 다각형만 다시 그리기
        // });



      } // displayDong 함수 끝




    });
  </script>


</body>

</html>
